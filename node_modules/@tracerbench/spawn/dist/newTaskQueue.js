"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Ensures each message will have its own microtask queue.
 */
function newTaskQueue() {
    const queue = [];
    let scheduled = false;
    let read = 0;
    let write = 0;
    return enqueue;
    function schedule() {
        scheduled = true;
        setImmediate(next);
    }
    function next() {
        scheduled = false;
        dequeue();
    }
    function enqueue(task) {
        queue[write++] = task;
        if (scheduled) {
            return;
        }
        schedule();
    }
    function dequeue() {
        const task = queue[read];
        // release memory
        queue[read++] = undefined;
        if (read < write) {
            schedule();
        }
        else {
            // empty reset back to zero
            read = write = 0;
        }
        task();
    }
}
exports.default = newTaskQueue;
//# sourceMappingURL=newTaskQueue.js.map