"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const find_chrome_1 = require("@tracerbench/find-chrome");
const spawn_1 = require("@tracerbench/spawn");
const canonicalizeOptions_1 = require("./canonicalizeOptions");
const createTmpDir_1 = require("./createTmpDir");
const getArguments_1 = require("./getArguments");
function spawnChrome(options, debugCallback) {
    const canonicalized = canonicalizeOptions_1.default(options);
    let chromeExecutable = canonicalized.chromeExecutable;
    if (chromeExecutable === undefined) {
        chromeExecutable = find_chrome_1.default();
    }
    let userDataDir = canonicalized.userDataDir;
    let onExit;
    if (userDataDir === undefined) {
        const [tmpDir, removeTmpDir] = createTmpDir_1.default(canonicalized.userDataRoot);
        userDataDir = tmpDir;
        onExit = () => {
            try {
                removeTmpDir();
            }
            catch (e) {
                if (debugCallback !== undefined) {
                    debugCallback("Removing temp user data dir %o failed with %o", tmpDir, e);
                }
            }
        };
    }
    const args = getArguments_1.default(userDataDir, canonicalized);
    const chromeProcess = Object.assign(spawn_1.default(chromeExecutable, args, canonicalized, "pipe", debugCallback), {
        userDataDir,
    });
    if (onExit !== undefined) {
        chromeProcess.once("exit", onExit);
    }
    return chromeProcess;
}
exports.default = spawnChrome;
//# sourceMappingURL=spawnChrome.js.map